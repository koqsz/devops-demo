# Nginx reverse proxy konfig – ArgoCD
# Fájl helye a szerveren: /etc/nginx/sites-available/argocd.conf
# Symlink: ln -s /etc/nginx/sites-available/argocd.conf /etc/nginx/sites-enabled/
#
# Előfeltétel: Let's Encrypt tanúsítvány
#   certbot --nginx -d argocd.pelda.com
#
# Az ArgoCD server HTTPS-en és gRPC-n kommunikál, ezért TCP passthrough
# megoldást használunk (stream modul), VAGY nginx HTTPS proxyt.
#
# Ez a fájl a HTTPS proxy megközelítést mutatja: nginx terminál SSL-t,
# majd HTTPS-en proxyzik az ArgoCD server service felé.
#
# Az ARGOCD_IP a Kubernetes cluster ArgoCD server service elérhetősége.
# Ha az ArgoCD Ingress-en keresztül éred el (ajánlott):
#   ARGOCD_IP = nginx Ingress Controller IP-je
# Ha közvetlen NodePort-on:
#   ARGOCD_IP:PORT = a node IP és NodePort

server {
    listen 80;
    server_name argocd.pelda.com;  # <-- Ide írd a valós ArgoCD domain nevet

    # HTTP → HTTPS átirányítás
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name argocd.pelda.com;  # <-- Ide írd a valós ArgoCD domain nevet

    # SSL tanúsítvány (Let's Encrypt - certbot generálja)
    ssl_certificate     /etc/letsencrypt/live/argocd.pelda.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/argocd.pelda.com/privkey.pem;

    # Modern SSL beállítások
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    # gRPC + HTTP/2 proxy az ArgoCD server felé
    # Az ArgoCD Ingress Controller-en keresztül érhető el
    location / {
        proxy_pass https://INGRESS_IP;  # <-- Ide írd az Ingress Controller IP-jét

        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # ArgoCD self-signed tanúsítványának elfogadása a belső proxy felé
        proxy_ssl_verify off;

        # gRPC / WebSocket támogatás (ArgoCD UI-hoz szükséges)
        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_connect_timeout 10s;
        proxy_send_timeout    300s;
        proxy_read_timeout    300s;
    }
}
